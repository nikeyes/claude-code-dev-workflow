#!/bin/bash
set -euo pipefail

# Validates workflow artifacts generated by Research → Plan → Implement → Validate cycle
# Usage: ./validate-workflow-artifacts.sh <project-name>

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_NAME="${1:-temperature-cli}"

echo "=== Validating workflow artifacts for: ${PROJECT_NAME} ==="
echo ""

FAILED=0
PASSED=0

check_file() {
    local filepath="$1"
    local description="$2"

    if [[ -f "${filepath}" ]]; then
        echo "✓ ${description}"
        echo "  Location: ${filepath}"
        ((PASSED++))
    else
        echo "✗ ${description}"
        echo "  Expected: ${filepath}"
        ((FAILED++))
    fi
}

check_content() {
    local filepath="$1"
    local pattern="$2"
    local description="$3"

    if [[ -f "${filepath}" ]] && grep -q "${pattern}" "${filepath}"; then
        echo "✓ ${description}"
        ((PASSED++))
    else
        echo "✗ ${description}"
        echo "  File: ${filepath}"
        echo "  Pattern: ${pattern}"
        ((FAILED++))
    fi
}

# 1. Research artifacts
echo "--- Phase 1: Research ---"
check_file "thoughts/shared/research/${PROJECT_NAME}.md" "Research document exists"
if [[ -f "thoughts/shared/research/${PROJECT_NAME}.md" ]]; then
    check_content "thoughts/shared/research/${PROJECT_NAME}.md" "## Architecture" "Contains architecture section"
    check_content "thoughts/shared/research/${PROJECT_NAME}.md" "## Key Files" "Contains key files section"
fi
echo ""

# 2. Plan artifacts
echo "--- Phase 2: Plan ---"
PLAN_FILE=$(find thoughts/shared/plans -name "*kelvin*.md" -o -name "*temperature*.md" 2>/dev/null | head -1)
if [[ -n "${PLAN_FILE}" ]]; then
    echo "✓ Implementation plan exists"
    echo "  Location: ${PLAN_FILE}"
    ((PASSED++))

    check_content "${PLAN_FILE}" "## Success Criteria" "Plan has success criteria"
    check_content "${PLAN_FILE}" "## Implementation Steps" "Plan has implementation steps"
else
    echo "✗ Implementation plan not found"
    echo "  Expected: thoughts/shared/plans/*kelvin*.md or *temperature*.md"
    ((FAILED++))
fi
echo ""

# 3. Implementation artifacts
echo "--- Phase 3: Implementation ---"
PROJECT_DIR="${SCRIPT_DIR}/${PROJECT_NAME}"

if [[ -d "${PROJECT_DIR}" ]]; then
    # Check for Kelvin implementation
    if grep -rq "celsius_to_kelvin\|kelvin_to_celsius" "${PROJECT_DIR}/src/" 2>/dev/null; then
        echo "✓ Kelvin conversion functions implemented"
        ((PASSED++))
    else
        echo "✗ Kelvin conversion functions not found"
        ((FAILED++))
    fi

    # Check for Kelvin tests
    if grep -rq "TestCelsiusToKelvin\|TestKelvinToCelsius" "${PROJECT_DIR}/tests/" 2>/dev/null; then
        echo "✓ Kelvin tests implemented"
        ((PASSED++))
    else
        echo "✗ Kelvin tests not found"
        ((FAILED++))
    fi

    # Run tests
    cd "${PROJECT_DIR}"
    if pytest tests/ -q &> /dev/null; then
        echo "✓ All tests pass"
        ((PASSED++))
    else
        echo "✗ Tests failing"
        ((FAILED++))
    fi
    cd - > /dev/null
else
    echo "✗ Project directory not found: ${PROJECT_DIR}"
    ((FAILED++))
fi
echo ""

# 4. Validation artifacts
echo "--- Phase 4: Validation ---"
VALIDATION_FILE=$(find thoughts/shared/plans -name "*validation*.md" 2>/dev/null | head -1)
if [[ -n "${VALIDATION_FILE}" ]]; then
    echo "✓ Validation report exists"
    echo "  Location: ${VALIDATION_FILE}"
    ((PASSED++))
else
    echo "⚠ Validation report not found (optional)"
    echo "  Expected: thoughts/shared/plans/*validation*.md"
fi
echo ""

# Summary
echo "==================================="
echo "SUMMARY: ${PASSED} passed, ${FAILED} failed"
echo "==================================="

if [[ ${FAILED} -eq 0 ]]; then
    echo "✓ All workflow phases completed successfully"
    exit 0
else
    echo "✗ Workflow validation failed"
    exit 1
fi
