#!/bin/bash
set -euo pipefail

# End-to-end workflow test
# Validates the complete Research → Plan → Implement → Validate cycle
#
# This script provides a framework for testing workflow commands.
# It does NOT automate Claude Code commands (which require interactive sessions).
# Instead, it validates the artifacts generated by manual workflow execution.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "=== E2E Workflow Test ==="
echo ""
echo "This test validates the claude-code-dev-workflow tooling."
echo "It checks that workflow artifacts are created correctly."
echo ""

# Color output helpers
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

# shellcheck disable=SC2329  # Function reserved for future use
print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Test mode selection
if [[ $# -eq 0 ]]; then
    cat <<EOF
Usage: ${0} <mode>

Modes:
  setup       - Run setup and verify baseline
  manual      - Instructions for manual workflow testing
  automated   - Run automated workflow with claude -p
  validate    - Validate workflow artifacts
  clean       - Clean up test artifacts
  full        - Run setup + show instructions + validate (interactive)

Examples:
  ${0} setup      # Prepare validation project
  ${0} manual     # Show workflow commands to run
  ${0} automated  # Execute workflow automatically with claude -p
  ${0} validate   # Check if artifacts were created
  ${0} full       # Complete guided test
EOF
    exit 1
fi

MODE="${1}"

# Setup mode: prepare environment
if [[ "${MODE}" == "setup" || "${MODE}" == "full" ]]; then
    echo "--- Running setup ---"

    # Make scripts executable
    chmod +x "${SCRIPT_DIR}/setup.sh"
    chmod +x "${SCRIPT_DIR}/validate-workflow-artifacts.sh"

    # Run setup
    if "${SCRIPT_DIR}/setup.sh"; then
        print_success "Setup completed"
    else
        print_error "Setup failed"
        exit 1
    fi

    echo ""
fi

# Manual mode: show instructions
if [[ "${MODE}" == "manual" || "${MODE}" == "full" ]]; then
    echo "--- Workflow Commands ---"
    echo ""
    echo "Run the following commands in Claude Code (interactive mode):"
    echo ""
    echo "1. RESEARCH:"
    echo "   cd ${SCRIPT_DIR}/temperature-cli"
    echo "   /research_codebase"
    echo ""
    echo "2. PLAN:"
    echo "   /create_plan \"Add Kelvin temperature scale support\""
    echo ""
    echo "3. IMPLEMENT:"
    echo "   /implement_plan thoughts/shared/plans/<plan-file>.md"
    echo ""
    echo "4. VALIDATE:"
    echo "   /validate_plan thoughts/shared/plans/<plan-file>.md"
    echo ""
    echo "After completing these steps, run:"
    echo "   ${0} validate"
    echo ""

    if [[ "${MODE}" == "full" ]]; then
        echo -n "Press Enter after completing workflow commands..."
        read -r
        echo ""
    else
        exit 0
    fi
fi

# Automated mode: run workflow with claude -p
if [[ "${MODE}" == "automated" ]]; then
    echo "--- Running automated workflow ---"
    echo ""

    # Make script executable
    chmod +x "${SCRIPT_DIR}/run-automated-workflow.sh"

    # Run automated workflow
    if "${SCRIPT_DIR}/run-automated-workflow.sh"; then
        print_success "Automated workflow completed"
        echo ""
        echo "Run '${0} validate' to verify artifacts"
    else
        print_error "Automated workflow failed"
        exit 1
    fi
    exit 0
fi

# Validate mode: check artifacts
if [[ "${MODE}" == "validate" || "${MODE}" == "full" ]]; then
    echo "--- Running validation ---"
    echo ""

    if "${SCRIPT_DIR}/validate-workflow-artifacts.sh" temperature-cli; then
        print_success "Workflow validation passed"
        echo ""
        echo "=== E2E Test: SUCCESS ==="
        exit 0
    else
        print_error "Workflow validation failed"
        echo ""
        echo "=== E2E Test: FAILED ==="
        echo ""
        echo "Troubleshooting:"
        echo "  - Check thoughts/shared/research/ for research docs"
        echo "  - Check thoughts/shared/plans/ for plan docs"
        echo "  - Verify Kelvin functions in temperature-cli/src/"
        echo "  - Run 'pytest temperature-cli/tests/' manually"
        exit 1
    fi
fi

# Clean mode: remove artifacts
if [[ "${MODE}" == "clean" ]]; then
    echo "--- Cleaning test artifacts ---"

    # Clean thoughts directory
    if [[ -d "thoughts" ]]; then
        rm -rf thoughts
        print_success "Removed thoughts/ directory"
    fi

    # Clean Python cache
    find "${SCRIPT_DIR}/temperature-cli" -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
    find "${SCRIPT_DIR}/temperature-cli" -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true

    print_success "Cleaned Python cache files"
    echo ""
    echo "Cleanup complete. Run '${0} setup' to reset."
    exit 0
fi

print_error "Unknown mode: ${MODE}"
exit 1
